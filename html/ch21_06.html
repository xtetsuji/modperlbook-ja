<html><head><title>Analyzing Dumped core Files (Practical mod_perl)</title><link rel="stylesheet" type="text/css" href="../style/style1.css" />

<meta name="DC.Creator" content="Stas Bekman and Eric Cholet" /><meta name="DC.Format" content="text/xml" scheme="MIME" /><meta name="DC.Language" content="en-US" /><meta name="DC.Publisher" content="O'Reilly &amp; Associates, Inc." /><meta name="DC.Source" scheme="ISBN" content="0-596-00227-0" /><meta name="DC.Subject.Keyword" content="stuff" /><meta name="DC.Title" content="Practical mod_perl" /><meta name="DC.Type" content="Text.Monograph" />

</head><body bgcolor="#ffffff">




<div class="navbar"><table width="684" border="0"><tr><td align="left" valign="top" width="228"><a href="ch21_05.html"><img src="../images//txtpreva.gif" alt="Previous" border="0" /></a></td><td align="center" valign="top" width="228" /><td align="right" valign="top" width="228"><a href="ch21_07.html"><img src="../images//txtnexta.gif" alt="Next" border="0" /></a></td></tr></table></div>



<h2 class="sect1">21.6. Analyzing Dumped core Files</h2>

<p>When your <a name="pmodperl-CHP-21-ITERM-5637" /><a name="pmodperl-CHP-21-ITERM-5638" /><a name="pmodperl-CHP-21-ITERM-5639" />application dies with the
"Segmentation fault" error
(generated by the default <tt class="literal">SIGSEGV</tt>signal handler)
and generates a <em class="emphasis">core</em> file, you can analyze the
<em class="emphasis">core</em> file using gdb or a similar debugger to
find out what caused the segmentation fault (or
<em class="emphasis">segfault</em>).</p>

<a name="pmodperl-CHP-21-SECT-6.1" /><div class="sect2">
<h3 class="sect2">21.6.1. Getting Ready to Debug</h3>

<p>To debug <a name="pmodperl-CHP-21-ITERM-5640" /><a name="pmodperl-CHP-21-ITERM-5641" />the
<em class="emphasis">core</em> file, you may need to recompile Perl and
mod_perl so that their executables contain debugging symbols. Usually
you have to recompile only mod_perl, but if the
<em class="emphasis">core</em> dump happens in the
<em class="emphasis">libperl.so</em> library and you want to see the whole
backtrace, you will probably want to recompile Perl as well.</p>

<p>For example, sometimes people send this kind of backtrace to the
mod_perl list:</p>

<blockquote><pre class="code">#0  0x40448aa2 in ?? ( )
#1  0x40448ac9 in ?? ( )
#2  0x40448bd1 in ?? ( )
#3  0x4011d5d4 in ?? ( )
#4  0x400fb439 in ?? ( )
#5  0x400a6288 in ?? ( )
#6  0x400a5e34 in ?? ( )</pre></blockquote>

<p>This kind of trace is absolutely useless, since you cannot tell where
the problem happens from just looking at machine addresses. To
preserve the debug symbols and get a meaningful backtrace, recompile
<a name="pmodperl-CHP-21-ITERM-5642" /><a name="pmodperl-CHP-21-ITERM-5643" />Perl with
<em class="emphasis">-DDEBUGGING</em> during the
<em class="emphasis">./Configure</em> stage (or with
<em class="emphasis">-Doptimize="-g</em>", which, in addition to adding
the <em class="emphasis">-DDEBUGGING</em> option, adds the
<em class="emphasis">-g</em> option, which allows you to debug the Perl
interpreter itself).</p>

<p>After recompiling Perl,
<a name="pmodperl-CHP-21-ITERM-5644" /><a name="pmodperl-CHP-21-ITERM-5645" />recompile mod_perl with
<tt class="literal">PERL_DEBUG=1</tt> during the <em class="emphasis">perl
Makefile.PL</em> stage. Building mod_perl with
<tt class="literal">PERL_DEBUG=1</tt> will:</p>

<ol><li>
<p>Add <em class="emphasis">-g</em> to <tt class="literal">EXTRA_CFLAGS</tt>,
passed to your C compiler during compilation.</p>
</li><li>
<p>Turn on the <tt class="literal">PERL_TRACE</tt> option.</p>
</li><li>
<p>Set <tt class="literal">PERL_DESTRUCT_LEVEL=2</tt>.</p>
</li><li>
<p>Link against <tt class="literal">libperld</tt> if <tt class="literal">-e
$Config{archlibexp}/CORE/libperld$Config{lib_ext}</tt> (i.e., if
you've compiled perl with
<em class="emphasis">-DDEBUGGING</em>).</p>
</li></ol>
<p>During <em class="emphasis">make install</em>, Apache strips all the
debugging symbols. To prevent this, you should use the Apache
<em class="emphasis">&#8212;without-execstrip</em>
<em class="emphasis">./configure</em> option. So if you configure Apache
via mod_perl, you should do this:</p>

<blockquote><pre class="code">panic% perl Makefile.PL USE_APACI=1 \
  APACI_ARGS='--without-execstrip' [other options]</pre></blockquote>

<p>Alternatively, you can copy the unstripped binary manually. For
example, we did this to give us an Apache binary called
<em class="emphasis">httpd_perl</em> that contains debugging symbols:</p>

<blockquote><pre class="code">panic# cp apache_1.3.24/src/httpd /home/httpd/httpd_perl/bin/httpd_perl</pre></blockquote>

<p>Now the software is ready for a proper debug.</p>

</div>
<a name="pmodperl-CHP-21-SECT-6.2" /><div class="sect2">
<h3 class="sect2">21.6.2. Creating a Faulty Package</h3>

<p>The nex<a name="pmodperl-CHP-21-ITERM-5646" /><a name="pmodperl-CHP-21-ITERM-5647" /><a name="pmodperl-CHP-21-ITERM-5648" />t stage is to create a package that
aborts abnormally with a segfault, so you will be able to reproduce
the problem and exercise the debugging technique explained here.
Luckily, you can download
<tt class="literal">Debug::DumpCore</tt><a name="pmodperl-CHP-21-ITERM-5649" /> from CPAN, which does a very simple
thing&#8212;it segfaults when called as:</p>

<blockquote><pre class="code">use Debug::DumpCore;
Debug::DumpCore::segv( );</pre></blockquote>

<p><tt class="literal">Debug::DumpCore::segv( )</tt> calls a function, which
calls another function, which dereferences a <tt class="literal">NULL</tt>
pointer, which causes the segfault:</p>

<blockquote><pre class="code">int *p;
p = NULL;
printf("%d", *p); // cause a segfault</pre></blockquote>

<p>For those unfamiliar with C programming, <em class="emphasis">p</em> is a
pointer to a segment of memory. Setting it to <tt class="literal">NULL</tt>
ensures that we try to read from a segment of memory to which the
operating system does not allow us access, so of course dereferencing
the <tt class="literal">NULL</tt> pointer through <tt class="literal">*p</tt>
causes a segmentation fault. And that's what we
want.</p>

<p>Of course, you can use Perl's <tt class="literal">CORE::dump(
)</tt><a name="pmodperl-CHP-21-ITERM-5650" /><a name="pmodperl-CHP-21-ITERM-5651" /> function, which causes a core dump,
but you don't get the nice long trace provided by
<tt class="literal">Debug::DumpCore</tt>, which on purpose calls a few
other functions before causing a segfault.</p>

</div>
<a name="pmodperl-CHP-21-SECT-6.3" /><div class="sect2">
<h3 class="sect2">21.6.3. Dumping the core File</h3>

<p>Now let's<a name="pmodperl-CHP-21-ITERM-5652" /><a name="pmodperl-CHP-21-ITERM-5653" /><a name="pmodperl-CHP-21-ITERM-5654" /> dump the
<em class="emphasis">core</em> file from within the mod_perl server.
Sometimes the program aborts abnormally via the
<tt class="literal">SIGSEGV</tt>signal (a segfault), but no
<em class="emphasis">core</em> file is dumped. And without the
<em class="emphasis">core</em> file it's hard to find the
cause of the problem, unless you run the program inside
<tt class="literal">gdb</tt> or another debugger in the first place. In
order to get the <em class="emphasis">core</em> file, the application
must:</p>

<ul><li>
<p>Have the same effective UID as the real UID (the same goes for GID).
This is the case with mod_perl unless you modify these settings in
the server configuration file.</p>
</li><li>
<p>Be running from a directory that is writable by the process at the
moment of the segmentation fault. Note that the program might change
its current directory during its run, so it's
possible that the <em class="emphasis">core</em> file will need to be
dumped in a different directory from the one from which the program
was started. For example when mod_perl runs an
<tt class="literal">Apache::Registry</tt>script, it changes its directory
to the one in which the script's source is located.</p>
</li><li>
<p>Be started from a shell process with sufficient resource allocations
for the <em class="emphasis">core</em> file to be dumped. You can override
the default setting from within a shell script if the process is not
started manually. In addition, you can use
<tt class="literal">BSD::Resource</tt> to manipulate the setting from
within the code as well.</p>
<p>You can use <em class="emphasis">ulimit</em> for a Bourne-style shell and
<em class="emphasis">limit</em> for a C-style shell to check and adjust
the resource allocation. For example, inside
<em class="emphasis">bash</em>, you may set the <em class="emphasis">core</em>
file size to unlimited with:</p>
<blockquote><pre class="code">panic% ulimit -c unlimited</pre></blockquote>
<p>or for <tt class="literal">csh</tt>:</p>
<blockquote><pre class="code">panic% limit coredumpsize unlimited</pre></blockquote>
<p>For example, you can set an upper limit of 8 MB on the
<em class="emphasis">core</em> file with:</p>
<blockquote><pre class="code">panic% ulimit -c 8388608</pre></blockquote>
<p>This ensures that if the <em class="emphasis">core</em> file would be
bigger than 8 MB, it will be not created.</p>
</li></ul>
<p>You must make sure that you have enough
disk<a name="pmodperl-CHP-21-ITERM-5655" /> space to create a big
<em class="emphasis">core</em> file (mod_perl <em class="emphasis">core</em>
files tend to be of a few MB in size).</p>

<p>Note that when you are running the program under a debugger like
<tt class="literal">gdb</tt>, which traps the <tt class="literal">SIGSEGV</tt>
signal, the <em class="emphasis">core</em> file will not be dumped.
Instead, <tt class="literal">gdb</tt> allows you to examine the program
stack and other things without having the <em class="emphasis">core</em>
file.</p>

<p>First let's test that we get the
<em class="emphasis">core</em> file from the command line (under
<em class="emphasis">tcsh</em>):</p>

<blockquote><pre class="code">panic% limit coredumpsize unlimited
panic% perl -MDebug::DumpCore -e 'Debug::DumpCore::segv( )'
Segmentation fault (core dumped)
panic% ls -l core
-rw------- 1 stas stas 954368 Jul 31 23:52 core</pre></blockquote>

<p>Indeed, we can see that the <em class="emphasis">core</em> file was
dumped. Let's write a simple script that uses
<tt class="literal">Debug::DumpCore</tt>, as shown in <a href="ch21_06.html#pmodperl-CHP-21-EX-9">Example 21-9</a>.</p>

<a name="pmodperl-CHP-21-EX-9" /><div class="example">
<h4 class="objtitle">Example 21-9. core_dump.pl</h4>
<blockquote><pre class="code">use strict;
use Debug::DumpCore ( );
use Cwd( )

my $r = shift;
$r-&gt;send_http_header("text/plain");

my $dir = getcwd;
$r-&gt;print("The core should be found at $dir/core\n");
Debug::DumpCore::segv( );</pre></blockquote>
</div>

<p>In this script we load the <tt class="literal">Debug::DumpCore</tt> and
<tt class="literal">Cwd</tt> modules. Then we acquire the request object
and send the HTTP headers. Now we come to the real part&#8212;we get
the current working directory, print out the location of the
<em class="emphasis">core</em> file that we are about to dump, and finally
call <tt class="literal">Debug::DumpCore::segv( )</tt>, which dumps the
<em class="emphasis">core</em> file.</p>

<p>Before we run the script we make sure that the shell sets the
<em class="emphasis">core</em> file size to be unlimited, start the server
in single-server mode as a non-<em class="emphasis">root</em> user, and
generate a request to the script:</p>

<blockquote><pre class="code">panic% cd /home/httpd/httpd_perl/bin
panic% limit coredumpsize unlimited
panic% ./httpd_perl -X
    # issue a request here
Segmentation fault (core dumped)</pre></blockquote>

<p>Our browser prints out:</p>

<blockquote><pre class="code">The core should be found at /home/httpd/perl/core</pre></blockquote>

<p>And indeed the <em class="emphasis">core</em> file appears where we were
told it would (remember that <tt class="literal">Apache::Registry</tt>
scripts change their directory to the location of the script source):</p>

<blockquote><pre class="code">panic% ls -l /home/httpd/perl/core
-rw------- 1 stas httpd 4669440 Jul 31 23:58 /home/httpd/perl/core</pre></blockquote>

<p>As you can see it's a 4.7 MB
<em class="emphasis">core</em> file. Notice that mod_perl was started as
user <em class="emphasis">stas</em>, which has write permission for the
directory <em class="emphasis">/home/httpd/perl</em>.</p>

</div>
<a name="pmodperl-CHP-21-SECT-6.4" /><div class="sect2">
<h3 class="sect2">21.6.4. Analyzing the core File</h3>

<p>First we<a name="pmodperl-CHP-21-ITERM-5656" /><a name="pmodperl-CHP-21-ITERM-5657" /> start
<tt class="literal">gdb</tt>, with the location of the mod_perl executable
and the <em class="emphasis">core</em> file as the arguments:</p>

<blockquote><pre class="code">panic% gdb /home/httpd/httpd_perl/bin/httpd_perl /home/httpd/perl/core</pre></blockquote>

<p>To see the
<a name="pmodperl-CHP-21-ITERM-5658" /><a name="pmodperl-CHP-21-ITERM-5659" />backtrace,
execute the <em class="emphasis">where</em><a name="pmodperl-CHP-21-ITERM-5660" /> or
<em class="emphasis">bt</em><a name="pmodperl-CHP-21-ITERM-5661" /> commands:</p>

<blockquote><pre class="code">(gdb) where
#0  0x4039f781 in crash_now_for_real (
    suicide_message=0x403a0120 "Cannot stand this life anymore")
    at DumpCore.xs:10
#1  0x4039f7a3 in crash_now (
    suicide_message=0x403a0120 "Cannot stand this life anymore",
    attempt_num=42) at DumpCore.xs:17
#2  0x4039f824 in XS_Debug_ _DumpCore_segv (cv=0x84ecda0)
    at DumpCore.xs:26
#3  0x401261ec in Perl_pp_entersub ( )
   from /usr/lib/perl5/5.6.1/i386-linux/CORE/libperl.so
#4  0x00000001 in ?? ( )</pre></blockquote>

<p>Notice that only the symbols from the
<em class="emphasis">DumpCore.xs</em> file are available (plus
<tt class="literal">Perl_pp_entersub</tt> from
<em class="emphasis">libperl.so</em>), since by default
<tt class="literal">Debug::DumpCore</tt> always compiles itself with the
<em class="emphasis">-g</em> flag. However, we cannot see the rest of the
trace, because our Perl and mod_perl libraries and Apache server were
built without the debug symbols. We need to recompile them all with
the debug symbols, as explained earlier in this chapter.</p>

<p>Then we repeat the process of starting the server, issuing a request,
and getting the <em class="emphasis">core</em> file, after which we run
<tt class="literal">gdb</tt> again against the executable and the dumped
<em class="emphasis">core</em> file:</p>

<blockquote><pre class="code">panic% gdb /home/httpd/httpd_perl/bin/httpd_perl /home/httpd/perl/core</pre></blockquote>

<p>Now we can see the whole backtrace:</p>

<blockquote><pre class="code">(gdb) bt
#0  0x40448aa2 in crash_now_for_real (
    suicide_message=0x404499e0 "Cannot stand this life anymore")
    at DumpCore.xs:10
#1  0x40448ac9 in crash_now (
    suicide_message=0x404499e0 "Cannot stand this life anymore",
    attempt_num=42) at DumpCore.xs:17
#2  0x40448bd1 in XS_Debug_ _DumpCore_segv (my_perl=0x8133b60, cv=0x861d1fc)
    at DumpCore.xs:26
#3  0x4011d5d4 in Perl_pp_entersub (my_perl=0x8133b60) at pp_hot.c:2773
#4  0x400fb439 in Perl_runops_debug (my_perl=0x8133b60) at dump.c:1398
#5  0x400a6288 in S_call_body (my_perl=0x8133b60, myop=0xbffff160, is_eval=0)
    at perl.c:2045
#6  0x400a5e34 in Perl_call_sv (my_perl=0x8133b60, sv=0x85d696c, flags=4)
    at perl.c:1963
#7  0x0808a6e3 in perl_call_handler (sv=0x85d696c, r=0x860bf54, args=0x0)
    at mod_perl.c:1658
#8  0x080895f2 in perl_run_stacked_handlers (hook=0x8109c47 "PerlHandler",
    r=0x860bf54, handlers=0x82e5c4c) at mod_perl.c:1371
#9  0x080864d8 in perl_handler (r=0x860bf54) at mod_perl.c:897
#10 0x080d2560 in ap_invoke_handler (r=0x860bf54) at http_config.c:517
#11 0x080e6796 in process_request_internal (r=0x860bf54) at http_request.c:1308
#12 0x080e67f6 in ap_process_request (r=0x860bf54) at http_request.c:1324
#13 0x080ddba2 in child_main (child_num_arg=0) at http_main.c:4595
#14 0x080ddd4a in make_child (s=0x8127ec4, slot=0, now=1028133659)
#15 0x080ddeb1 in startup_children (number_to_start=4) at http_main.c:4792
#16 0x080de4e6 in standalone_main (argc=2, argv=0xbffff514) at http_main.c:5100
#17 0x080ded04 in main (argc=2, argv=0xbffff514) at http_main.c:5448
#18 0x40215082 in _ _libc_start_main ( ) from /lib/i686/libc.so.6</pre></blockquote>

<p>Reading the trace from bottom to top, we can see that it starts with
Apache functions, moves on to the mod_perl and then Perl functions,
and finally calls functions from the
<tt class="literal">Debug::DumpCore</tt> package. At the top we can see the
<tt class="literal">crash_now_for_real( )</tt> function, which was the one
that caused the segmentation fault; we can also see that the faulty
code was at line 10 of the <em class="emphasis">DumpCore.xs</em> file. And
indeed, if we look at that line number we can see the reason for the
segfault&#8212;the dereferencing of the <tt class="literal">NULL</tt>
pointer:</p>

<blockquote><pre class="code">9: int *p = NULL;
  10: printf("%d", *p); /* cause a segfault */</pre></blockquote>

<p>In our example, we knew what Perl script had caused the segmentation
fault. In the real world, it is likely that you'll
have only the <em class="emphasis">core</em> file, without any clue as to
which handler or script has triggered it. The special
<em class="emphasis">curinfo</em><a name="pmodperl-CHP-21-ITERM-5662" /> <tt class="literal">gdb</tt> macro can help:</p>

<blockquote><pre class="code">panic% gdb /home/httpd/httpd_perl/bin/httpd_perl /home/httpd/perl/core
(gdb) source mod_perl-1.xx/.gdbinit
(gdb) curinfo
9:/home/httpd/perl/core_dump.pl</pre></blockquote>

<p>Start the <tt class="literal">gdb</tt> debugger as before.
<em class="emphasis">.gdbinit</em>, the file with various useful
<tt class="literal">gdb</tt> macros, is located in the source tree of
mod_perl. We use the <tt class="literal">gdb</tt>
<em class="emphasis">source</em> function to load these macros, and when
we run the <em class="emphasis">curinfo</em> macro we learn that the
<em class="emphasis">core</em> was dumped when
<em class="emphasis">/home/httpd/perl/core_dump.pl</em> was executing the
code at line 9.</p>

<p>These are the bits of information that are important in order to
reproduce and resolve a problem: the filename and line number where
the fault occurred (the faulty function is
<tt class="literal">Debug::DumpCore::segv( )</tt> in our case) and the
actual line where the segmentation fault occurred (the
<tt class="literal">printf("%d", *p)</tt> call in XS code). The former is
important for problem reproducing, since it's
possible that if the same function was called from a different script
the problem wouldn't show up (not the case in our
example, where using a dereferenced <tt class="literal">NULL</tt> pointer
will always cause a segmentation fault).</p>

</div>
<a name="pmodperl-CHP-21-SECT-6.5" /><div class="sect2">
<h3 class="sect2">21.6.5. Extracting the Backtrace Automatically</h3>

<p>With the help
<a name="pmodperl-CHP-21-ITERM-5663" /><a name="pmodperl-CHP-21-ITERM-5664" />of
<tt class="literal">Debug::FaultAutoBT</tt><a name="pmodperl-CHP-21-ITERM-5665" />, you can try to get the backtrace
extracted automatically, without any need for the
<em class="emphasis">core</em> file. As of this writing this CPAN module
is very new and doesn't work on all platforms.</p>

<p>To use this module we simply add the following code in the startup
file:</p>

<blockquote><pre class="code">use Debug::FaultAutoBT;
use File::Spec::Functions;
my $tmp_dir = File::Spec::Functions::tmpdir;
die "cannot find out a temp dir" if $tmp_dir eq '';
my $trace = Debug::FaultAutoBT-&gt;new(dir =&gt; "$tmp_dir");
$trace-&gt;ready( );</pre></blockquote>

<p>This code tries to automatically figure out the location of the
temporary directory, initializes the
<tt class="literal">Debug::FaultAutoBT</tt> object with it, and finally
uses the method <tt class="literal">ready( )</tt> to set the signal
handler, which will attempt to automatically get the backtrace. Now
when we repeat the process of starting the server and issuing a
request, if we look at the <em class="emphasis">error_log</em> file, it
says:</p>

<blockquote><pre class="code">SIGSEGV (Segmentation fault) in 29072
writing to the core file /tmp/core.backtrace.29072</pre></blockquote>

<p>And indeed the file <em class="emphasis">/tmp/core.backtrace.29072</em>
includes a backtrace similar to the one we extracted before, using
the <em class="emphasis">core</em> file.</p>

</div>


<hr width="684" align="left" />
<div class="navbar"><table width="684" border="0"><tr><td align="left" valign="top" width="228"><a href="ch21_05.html"><img src="../images//txtpreva.gif" alt="Previous" border="0" /></a></td><td align="center" valign="top" width="228"><a href="index.html"><img src="../images//txthome.gif" alt="Home" border="0" /></a></td><td align="right" valign="top" width="228"><a href="ch21_07.html"><img src="../images//txtnexta.gif" alt="Next" border="0" /></a></td></tr><tr><td align="left" valign="top" width="228">21.5. Debugging Perl Code</td><td align="center" valign="top" width="228"><a href="index/index.html"><img src="../images//index.gif" alt="Book Index" border="0" /></a></td><td align="right" valign="top" width="228">21.7. Hanging Processes: Detection and Diagnostics</td></tr></table></div>
<hr width="684" align="left" />


<p><p><font size="-1"><a href="copyrght.html">Copyright &copy; 2003</a> O'Reilly &amp; Associates. All rights reserved.</font></p>

<map name="library-map">
<area shape="rect" coords="0,0,85,92" href="../index.html"><area shape="rect" coords="89,1,204,113" href="../apache/index.html"><area shape="rect" coords="208,-1,296,136" href="../php/index.html"><area shape="rect" coords="301,-1,403,132" href="../modperl/index.html"><area shape="rect" coords="406,3,503,115" href="../mysql/index.html"><area shape="rect" coords="507,2,596,142" href="../lian/index.html"><area shape="rect" coords="600,1,690,127" href="../rlinux/index.html">
</map>

</body></html>